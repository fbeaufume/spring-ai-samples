<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.10.2/dist/cdn.min.js" defer></script>
    <style>
        .chat-container {
            max-width: 1000px;
            margin: auto;
            margin-top: 20px;
            height: 70vh;
            display: flex;
            flex-direction: column;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .chat-input {
            display: flex;
            padding: 10px;
        }

        .chat-bubble {
            max-width: 80%;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        /* Remove the bottom margin of the last "p" of the HTML generated by Marked */
        .chat-bubble p:last-child {
            margin-bottom: 0;
        }

        .chat-bubble.bot {
            background-color: #f1f1f1;
            align-self: flex-start;
        }

        .chat-bubble.user {
            background-color: #007bff;
            color: white;
            align-self: flex-end;
        }
    </style>
</head>
<body>
<div class="chat-container" x-data="chatApp()">
    <h2 class="text-center">Chat assistant</h2>
    <div class="chat-messages" x-ref="messages">
        <template x-for="message in messages" :key="message.id">
            <div :class="`chat-bubble ${message.sender}`" x-html="message.content"></div>
        </template>
    </div>
    <div class="chat-input">
        <input type="text" class="form-control" placeholder="Type a request..." x-model="userRequest"
               @keydown.enter="sendRequest">
        <button class="btn btn-primary ms-2" @click="sendRequest">Send</button>
        <button class="btn btn-primary ms-2" @click="clearConversation">Clear</button>
    </div>
</div>

<script>
    let conversationId = (new URLSearchParams(window.location.search)).get('conversation');

    // Redirection if no "conversation" query parameter is present
    (function ensureConversationParam(length = 9) {
        if (!conversationId) {
            const params = new URLSearchParams(window.location.search);
            params.set('conversation', String(Math.floor(Math.random() * 10**length)).padStart(length, '0'));
            window.location.search = params.toString();
        }
    })();

    function chatApp() {
        return {
            messages: [
                {id: 1, content: marked.parse('Hello! How can I help you?'), sender: 'bot'}
            ],
            userRequest: '',
            pushMessage(message, sender) {
                this.messages.push({id: Date.now(), content: marked.parse(message), sender: sender});
                this.$nextTick(() => {
                    this.$refs.messages.scrollTop = this.$refs.messages.scrollHeight;
                });
            },
            sendRequest() {
                if (this.userRequest.trim() === '') return;
                this.pushMessage(this.userRequest, 'user');
                fetch(`/chat?conversation=${conversationId}&request=${encodeURIComponent(this.userRequest)}`)
                    .then(response => response.text())
                    .then(data => this.pushMessage(data, 'bot'))
                    .catch(error => console.error('Error:', error));
                this.userRequest = '';
            },
            clearConversation() {
                fetch(`/conversations/clear?conversation=${conversationId}`)
                    .then(_ => this.messages = [])
                    .catch(error => console.error('Error:', error));
            }
        }
    }
</script>
</body>
</html>
